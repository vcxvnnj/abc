<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AI éš”ç©ºæ‰‹åŠ¿ç”»æ¿ (ä¿®å¤ç‰ˆ)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- ä½¿ç”¨ unpkg CDNï¼Œåœ¨å›½å†…æœ‰æ—¶å€™æ¯” jsdelivr ç¨³å®šä¸€ç‚¹ -->
    <script src="https://unpkg.com/@mediapipe/camera_utils/camera_utils.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@mediapipe/control_utils/control_utils.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@mediapipe/drawing_utils/drawing_utils.js" crossorigin="anonymous"></script>
    <script src="https://unpkg.com/@mediapipe/hands/hands.js" crossorigin="anonymous"></script>
    
    <style>
        body { margin: 0; padding: 0; overflow: hidden; background-color: #000; font-family: sans-serif; }
        #output_canvas {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 1;
            transform: scaleX(-1); /* é•œåƒ */
        }
        #ui_overlay {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 2; pointer-events: none;
        }
        .loading-screen {
            position: fixed; top: 0; left: 0; right: 0; bottom: 0;
            background: #111; color: white;
            display: flex; flex-direction: column; align-items: center; justify-content: center;
            z-index: 100; transition: opacity 0.5s;
        }
        .virtual-menu {
            position: absolute; top: 50%; left: 50%;
            transform: translate(-50%, -50%) scale(0.8);
            width: 80%; max-width: 400px;
            background: rgba(20, 20, 20, 0.95);
            border: 2px solid #00d2ff; border-radius: 20px;
            padding: 20px; display: grid; grid-template-columns: 1fr 1fr; gap: 15px;
            opacity: 0; transition: all 0.3s; pointer-events: none;
        }
        .virtual-menu.active { opacity: 1; transform: translate(-50%, -50%) scale(1); }
        .menu-item {
            background: rgba(255, 255, 255, 0.1); border-radius: 12px; padding: 15px;
            text-align: center; color: white; border: 2px solid transparent;
        }
        .menu-item.selected { background: #00d2ff; color: black; }
        .color-dot { width: 30px; height: 30px; border-radius: 50%; display: inline-block; border: 2px solid #fff; }
        #debug_info {
            position: absolute; top: 10px; left: 10px; color: yellow; font-family: monospace; font-size: 12px; z-index: 10;
        }
    </style>
</head>
<body>

    <!-- åŠ è½½å±‚ -->
    <div id="loading" class="loading-screen">
        <div class="text-3xl font-bold mb-4">ğŸ– åˆå§‹åŒ–ä¸­...</div>
        <div id="loading_text" class="text-sm text-gray-400 text-center px-4">
            æ­£åœ¨ä» Google ä¸‹è½½ AI æ¨¡å‹ (çº¦10MB)...<br>
            å¦‚æœé•¿æ—¶é—´å¡ä½ï¼Œè¯·æ£€æŸ¥ç½‘ç»œæˆ–å¼€å¯ä»£ç†ã€‚<br>
            <span style="color:red">è¯·å‹¿ç›´æ¥åŒå‡»HTMLæ–‡ä»¶æ‰“å¼€ï¼Œè¯·ä½¿ç”¨ localhost æˆ– HTTPS</span>
        </div>
        <div class="mt-8 w-64 h-2 bg-gray-800 rounded overflow-hidden">
            <div id="loading_bar" class="h-full bg-blue-500 w-0 transition-all duration-300"></div>
        </div>
    </div>

    <video id="input_video" style="display:none"></video>
    <canvas id="output_canvas"></canvas>

    <div id="ui_overlay">
        <div id="debug_info">FPS: 0 | Model: Loading...</div>
        <div class="absolute top-5 right-5 bg-black/50 px-4 py-2 rounded-full text-white text-sm">
            <span id="current_tool">âœï¸ ç”»ç¬”</span>
        </div>

        <div id="menu_panel" class="virtual-menu">
            <div class="col-span-2 text-center text-white font-bold border-b border-gray-600 pb-2">å·¥å…·ç®± (é£ŸæŒ‡æ‚¬åœé€‰æ‹©)</div>
            <div class="menu-item" data-action="tool_pen">âœï¸ ç”»ç¬”</div>
            <div class="menu-item" data-action="tool_eraser">ğŸ§¹ æ©¡çš®</div>
            <div class="menu-item" data-action="color_red"><div class="color-dot" style="background:#f44"></div></div>
            <div class="menu-item" data-action="color_green"><div class="color-dot" style="background:#4f4"></div></div>
            <div class="menu-item" data-action="color_blue"><div class="color-dot" style="background:#44f"></div></div>
            <div class="menu-item" data-action="clear_all">ğŸ—‘ï¸ æ¸…ç©ºæ‰€æœ‰</div>
        </div>
        
        <div class="absolute bottom-10 w-full text-center text-white/70 text-xs">
            âœ‹ å¼ å¼€æ‰‹æŒ: èœå• | ğŸ‘Œ æåˆ: å†™å­— | â˜ï¸+âœŒï¸(å‰ªåˆ€æ‰‹): é›ªèŠ±æ¶ˆæ•£
        </div>
    </div>

    <script>
        const videoElement = document.getElementById('input_video');
        const canvasElement = document.getElementById('output_canvas');
        const canvasCtx = canvasElement.getContext('2d');
        const loadingScreen = document.getElementById('loading');
        const loadingBar = document.getElementById('loading_bar');
        const debugInfo = document.getElementById('debug_info');
        
        let isModelLoaded = false;
        let lastFrameTime = 0;
        let particles = [];
        
        // çŠ¶æ€æœº
        let state = {
            menuOpen: false,
            tool: 'pen',
            color: '#ff4444',
            lineWidth: 4,
            scale: 1,
            drawing: false,
            menuTimer: 0
        };

        let strokes = []; // {points:[], color, width}
        let currentLine = [];

        // è°ƒæ•´ç”»å¸ƒå°ºå¯¸
        function resize() {
            canvasElement.width = window.innerWidth;
            canvasElement.height = window.innerHeight;
        }
        window.onresize = resize;
        resize();

        // --- ç²’å­ç³»ç»Ÿ ---
        class Particle {
            constructor(x, y, color) {
                this.x = x; this.y = y; this.color = color;
                this.vx = (Math.random()-0.5)*5; this.vy = Math.random()*5;
                this.life = 1.0;
            }
            update() { this.x += this.vx; this.y += this.vy; this.life -= 0.02; }
            draw(ctx) { 
                ctx.globalAlpha = this.life; ctx.fillStyle = this.color; 
                ctx.beginPath(); ctx.arc(this.x, this.y, 2, 0, Math.PI*2); ctx.fill(); 
            }
        }

        // --- æ ¸å¿ƒé€»è¾‘ ---
        function onResults(results) {
            // 1. é¦–æ¬¡æˆåŠŸæ£€æµ‹ï¼šå…³é—­åŠ è½½å±‚
            if (!isModelLoaded) {
                isModelLoaded = true;
                loadingBar.style.width = "100%";
                setTimeout(() => loadingScreen.style.opacity = 0, 500);
                setTimeout(() => loadingScreen.style.display = 'none', 1000);
            }

            // è®¡ç®— FPS
            const now = performance.now();
            const fps = 1000 / (now - lastFrameTime);
            lastFrameTime = now;
            debugInfo.innerText = `FPS: ${fps.toFixed(1)} | Hands: ${results.multiHandLandmarks.length}`;

            // 2. ç»˜åˆ¶åŸºç¡€å›¾å±‚
            canvasCtx.save();
            canvasCtx.clearRect(0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.drawImage(results.image, 0, 0, canvasElement.width, canvasElement.height);
            canvasCtx.fillStyle = 'rgba(0,0,0,0.4)'; // å˜æš—èƒŒæ™¯ä»¥ä¾¿çœ‹æ¸…å­—
            canvasCtx.fillRect(0,0, canvasElement.width, canvasElement.height);

            // 3. å¤„ç†æ‰‹åŠ¿
            if (results.multiHandLandmarks.length > 0) {
                const landmarks = results.multiHandLandmarks[0];
                const w = canvasElement.width;
                const h = canvasElement.height;

                // è·å–å…³é”®ç‚¹åæ ‡ (é•œåƒå¤„ç†: x = 1 - x)
                const indexTip = { x: (1 - landmarks[8].x) * w, y: landmarks[8].y * h };
                const thumbTip = { x: (1 - landmarks[4].x) * w, y: landmarks[4].y * h };
                const middleTip = { x: (1 - landmarks[12].x) * w, y: landmarks[12].y * h };
                
                // ç»˜åˆ¶æ‰‹éƒ¨éª¨æ¶
                drawConnectors(canvasCtx, landmarks, HAND_CONNECTIONS, {color: '#00ff00', lineWidth: 1});

                // --- æ‰‹åŠ¿è¯†åˆ«ç®—æ³• ---
                
                // A. è®¡ç®—è·ç¦»
                const pinchDist = Math.hypot(indexTip.x - thumbTip.x, indexTip.y - thumbTip.y);
                const peaceDist = Math.hypot(indexTip.x - middleTip.x, indexTip.y - middleTip.y); // é£ŸæŒ‡ä¸ä¸­æŒ‡è·ç¦»
                const isHandOpen = landmarks[20].y < landmarks[18].y && landmarks[16].y < landmarks[14].y && landmarks[12].y < landmarks[10].y && landmarks[8].y < landmarks[6].y;

                // B. çŠ¶æ€æœºé€»è¾‘
                
                // 1. å‰ªåˆ€æ‰‹æ¶ˆæ•£ (é£ŸæŒ‡ä¸­æŒ‡åˆ†å¼€ï¼Œå…¶ä»–å¼¯æ›²ï¼Œè¿™é‡Œç®€åŒ–ä¸ºæ£€æµ‹â€œVâ€å­—æ‰‹åŠ¿)
                // ç®€å•åˆ¤å®šï¼šé£ŸæŒ‡ä¸­æŒ‡éƒ½ä¼¸ç›´ï¼Œä¸”ç¦»å¾—æ¯”è¾ƒè¿œ
                if (!state.menuOpen && results.multiHandLandmarks.length === 1) {
                    // å¦‚æœé£ŸæŒ‡å’Œä¸­æŒ‡æŒ‡å°–è·ç¦» > 50px (è§†æƒ…å†µè°ƒæ•´) ä¸”æ²¡æœ‰æåˆ
                    if (Math.hypot(landmarks[8].x - landmarks[12].x, landmarks[8].y - landmarks[12].y) > 0.05 && pinchDist > 60) {
                         // è§¦å‘é›ªèŠ±
                         if (strokes.length > 0) {
                             strokes.forEach(s => s.points.forEach(p => {
                                 if(Math.random()>0.8) particles.push(new Particle(p.x, p.y, s.color));
                             }));
                             strokes = [];
                             currentLine = [];
                         }
                    }
                }

                // 2. èœå•å¼€å…³ (äº”æŒ‡å¼ å¼€)
                // è¿™é‡Œç”¨ç®€å•çš„é€»è¾‘ï¼šå¦‚æœæ˜¯å¼ å¼€æ‰‹æŒä¸”ä¸æ˜¯åœ¨ç”»ç”»
                if (isHandOpen && pinchDist > 80) {
                    if (!state.menuOpen) {
                        state.menuOpen = true;
                        document.getElementById('menu_panel').classList.add('active');
                    }
                } else if (state.menuOpen && pinchDist < 30) {
                    // åœ¨èœå•æ¨¡å¼ä¸‹æåˆï¼Œå¯èƒ½æ˜¯è¯¯æ“ä½œæˆ–æƒ³å…³é—­ï¼Œè¿™é‡Œç®€åŒ–ä¸ºå¦‚æœä¸å¼ å¼€å°±å°è¯•å…³é—­
                    // ä¸ºäº†ä½“éªŒï¼Œæˆ‘ä»¬è®©èœå•ä¿æŒæ‰“å¼€ç›´åˆ°é€‰æ‹©äº†ä¸œè¥¿ï¼Œæˆ–è€…æ‰‹ç¦»å¼€
                }

                // 3. èœå•äº¤äº’
                if (state.menuOpen) {
                    canvasCtx.beginPath();
                    canvasCtx.arc(indexTip.x, indexTip.y, 10, 0, Math.PI*2);
                    canvasCtx.fillStyle = 'cyan';
                    canvasCtx.fill();
                    
                    checkMenuHover(indexTip.x, indexTip.y);
                } 
                // 4. ä¹¦å†™æ¨¡å¼
                else {
                    // æåˆåˆ¤å®š (é˜ˆå€¼ 40åƒç´ )
                    if (pinchDist < 40) {
                        if (!state.drawing) {
                            state.drawing = true;
                            currentLine = [];
                        }
                        currentLine.push({x: indexTip.x, y: indexTip.y});
                    } else {
                        if (state.drawing) {
                            state.drawing = false;
                            if (currentLine.length > 0) {
                                strokes.push({points: [...currentLine], color: state.color, width: state.lineWidth, tool: state.tool});
                            }
                        }
                    }
                    
                    // ç»˜åˆ¶ç¬”å°–å…‰æ ‡
                    canvasCtx.beginPath();
                    canvasCtx.arc(indexTip.x, indexTip.y, 5, 0, Math.PI*2);
                    canvasCtx.fillStyle = state.drawing ? 'red' : 'white';
                    canvasCtx.fill();
                }
            }

            // 4. æ¸²æŸ“ç¬”è¿¹
            strokes.forEach(s => drawLine(s));
            if (state.drawing && currentLine.length > 0) {
                drawLine({points: currentLine, color: state.color, width: state.lineWidth, tool: state.tool});
            }

            // 5. æ¸²æŸ“ç²’å­
            if (particles.length > 0) {
                particles = particles.filter(p => p.life > 0);
                particles.forEach(p => { p.update(); p.draw(canvasCtx); });
            }

            canvasCtx.restore();
        }

        function drawLine(stroke) {
            if (stroke.points.length < 2) return;
            canvasCtx.beginPath();
            canvasCtx.lineWidth = stroke.width;
            canvasCtx.lineCap = 'round';
            canvasCtx.lineJoin = 'round';
            canvasCtx.strokeStyle = stroke.tool === 'eraser' ? 'rgba(0,0,0,0.5)' : stroke.color;
            // æ©¡çš®æ“¦å…¶å®åº”è¯¥ç”¨ globalCompositeOperationï¼Œä½†è¿™é‡Œç®€åŒ–ä¸ºåŠé€æ˜é»‘
            
            canvasCtx.moveTo(stroke.points[0].x, stroke.points[0].y);
            for(let i=1; i<stroke.points.length; i++) {
                canvasCtx.lineTo(stroke.points[i].x, stroke.points[i].y);
            }
            canvasCtx.stroke();
        }

        let selectionTimer = 0;
        let lastSelected = null;

        function checkMenuHover(x, y) {
            const items = document.querySelectorAll('.menu-item');
            let hovered = false;
            
            items.forEach(item => {
                const rect = item.getBoundingClientRect();
                if (x > rect.left && x < rect.right && y > rect.top && y < rect.bottom) {
                    hovered = true;
                    item.classList.add('selected');
                    if (lastSelected !== item) {
                        selectionTimer = 0;
                        lastSelected = item;
                    } else {
                        selectionTimer++;
                    }

                    // æ‚¬åœ 20 å¸§ (çº¦0.5ç§’) è§¦å‘
                    if (selectionTimer > 20) {
                        const action = item.dataset.action;
                        executeAction(action);
                        state.menuOpen = false;
                        document.getElementById('menu_panel').classList.remove('active');
                        selectionTimer = 0;
                    }
                } else {
                    item.classList.remove('selected');
                }
            });
            
            if (!hovered) { selectionTimer = 0; lastSelected = null; }
        }

        function executeAction(action) {
            if (action === 'tool_pen') { state.tool = 'pen'; document.getElementById('current_tool').innerText = "âœï¸ ç”»ç¬”"; }
            if (action === 'tool_eraser') { state.tool = 'eraser'; state.color = '#000'; document.getElementById('current_tool').innerText = "ğŸ§¹ æ©¡çš®"; }
            if (action === 'color_red') { state.color = '#ff4444'; state.tool = 'pen'; }
            if (action === 'color_green') { state.color = '#44ff44'; state.tool = 'pen'; }
            if (action === 'color_blue') { state.color = '#4444ff'; state.tool = 'pen'; }
            if (action === 'clear_all') { strokes = []; particles = []; }
        }

        // --- åˆå§‹åŒ– MediaPipe ---
        const hands = new Hands({locateFile: (file) => {
            // ä½¿ç”¨ unpkg æºï¼Œå°è¯•è§£å†³å›½å†…åŠ è½½é—®é¢˜
            return `https://unpkg.com/@mediapipe/hands/${file}`;
        }});

        hands.setOptions({
            maxNumHands: 2,
            modelComplexity: 1,
            minDetectionConfidence: 0.5,
            minTrackingConfidence: 0.5
        });

        hands.onResults(onResults);

        // è¶…æ—¶æ£€æµ‹
        setTimeout(() => {
            if (!isModelLoaded) {
                alert("åŠ è½½è¶…æ—¶ï¼\n1. è¯·æ£€æŸ¥ç½‘ç»œè¿æ¥ã€‚\n2. ä¸­å›½å¤§é™†ç”¨æˆ·å¯èƒ½éœ€è¦ä»£ç†ã€‚\n3. è¯·ç¡®ä¿ä½¿ç”¨ HTTPS åè®®æ‰“å¼€ç½‘é¡µã€‚");
                document.getElementById('loading_text').innerHTML = "<span style='color:red'>æ¨¡å‹ä¸‹è½½å¤±è´¥ï¼Œè¯·åˆ·æ–°é‡è¯•</span>";
            }
        }, 15000);

        // å¯åŠ¨æ‘„åƒå¤´
        const camera = new Camera(videoElement, {
            onFrame: async () => {
                await hands.send({image: videoElement});
            },
            width: 1280,
            height: 720
        });
        
        camera.start().then(() => {
            console.log("æ‘„åƒå¤´å·²å¯åŠ¨ï¼Œæ­£åœ¨ç­‰å¾…æ¨¡å‹...");
            loadingBar.style.width = "50%";
        }).catch(e => {
            alert("æ‘„åƒå¤´å¯åŠ¨å¤±è´¥: " + e.message);
        });
    </script>
</body>
</html>

